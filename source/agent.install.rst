OpenSVC Agent installation
**************************

Package
=======

Download the lastest OpenSVC package available for your operating system of choice from http://repo.opensvc.com and install it. Depending on the operating system, and operating system version, you might need to satisfy dependencies using packages provided on this website.

The package post-installation steps are handled by the ``/opt/opensvc/bin/postinstall`` script. This script can be safely executed on a node where OpenSVC is already installed.

Files
=====

The package installs the following directory tree::

	/opt/opensvc/
	/opt/opensvc/etc
	/opt/opensvc/tmp
	/opt/opensvc/bin
	/opt/opensvc/bin/pkg
	/opt/opensvc/bin/cron
	/opt/opensvc/var
	/opt/opensvc/var/sync
	/opt/opensvc/var/lock
	/opt/opensvc/usr
	/opt/opensvc/usr/share
	/opt/opensvc/usr/share/doc
	/opt/opensvc/lib
	/opt/opensvc/log

Cron jobs
=========

The package installs the following cron jobs, in (by order of preference), ``/etc/cron.d/opensvc``, ``/var/spool/cron/crontabs/root``, ``/var/spool/cron/root``::

	0,10,20,30,40,50 * * * * [ -x /opt/opensvc/bin/svcmon ] && /opt/opensvc/bin/svcmon --updatedb --maxdelaydb 120 >/dev/null 2>&1
	0,10,20,30,40,50 * * * * [ -x /opt/opensvc/bin/cron/opensvc ] && /opt/opensvc/bin/cron/opensvc >/dev/null 2>&1


Linux and HP-UX also have a helper to gather statistics::

	0,10,20,30,40,50 * * * * root [ -x /opt/opensvc/bin/perfagt.Linux ] && /opt/opensvc/bin/perfagt.Linux >/dev/null 2>&1

Keys
====

If the root account has no ssh key, a 1024 bits dsa key is generated by the package post-install. Production node keys must be trusted on all cluster nodes (PRD and DRP), whereas the keys of disaster recovery servers must not be trusted by production nodes. This setup is used for rsync file transfers and remote command execution.

Set host mode::

	/opt/opensvc/bin/nodemgr set --param node.host_mode --value PRD


The valid host mode values are PRD, DEV, TST. The setting is stored in ``/opt/opensvc/etc/node.conf``. On a fresh install this file does not exist. Note that the ``/opt/opensvc/var/host_mode`` file is deprecated. Upgrading the new OpenSVC package on a system with a ``/opt/opensvc/var/host_mode`` file will move the value to ``/opt/opensvc/etc/node.conf``.

The host_mode setting is used to enforce the following policies:

*   Only PRD services are allowed to start on a PRD node
*   Only PRD nodes are allowed to push data to a PRD node

Set schedules
=============

Schedules are defined in ``/opt/opensvc/etc/node.conf``. The OpenSVC agent schedules the following actions:

+--------------+----------------------------------------------+--------------+---------------------+-----------------+
| Action       | Description                                  | Section name | Default             | Statistic Delay |
+==============+==============================================+==============+=====================+=================+
| pushstats    | Send to the collector the collected          | [stats]      | 4am-6am daily       | Yes             |
|              | performance metrics since last pushstats     |              |                     |                 |
+--------------+----------------------------------------------+--------------+---------------------+-----------------+
| pushasset    | Send to the collector the collected node     | [asset]      | 4am-6am daily       | Yes             |
|              | information (cpu, memory, board, ...)        |              |                     |                 |
+--------------+----------------------------------------------+--------------+---------------------+-----------------+
| pushpkg      | Send to the collector the node installed     | [packages]   | 4am-6am daily       | Yes             |
|              | package database                             |              |                     |                 |
+--------------+----------------------------------------------+--------------+---------------------+-----------------+
| pushpatch    | Send to the collector the node installed     | [patches]    | 4am-6am daily       | Yes             |
|              | patch database                               |              |                     |                 |
+--------------+----------------------------------------------+--------------+---------------------+-----------------+
| checks       | Send to the collector the node checks        | [checks]     | 4am-6am daily       | Yes             |
|              | results (fs_u, fs_i, vg_u, ...)              |              |                     |                 |
+--------------+----------------------------------------------+--------------+---------------------+-----------------+
| compliance   | Send to the collector the compliance modules | [comp]       | 2am-6am sundays     | Yes             |
| check	       | checks results                               |              |                     |                 |
+--------------+----------------------------------------------+--------------+---------------------+-----------------+
| pushservices | Send to the collector the service            | [svcconf]    | 4am-6am daily       | Yes             |
|              | configurations                               |              |                     |                 |
+--------------+----------------------------------------------+--------------+---------------------+-----------------+
| syncservices | Try a ``syncall`` action on all node's       | None         | 4am-6am daily       | No              |
|              | services                                     |              |                     |                 |
+--------------+----------------------------------------------+--------------+---------------------+-----------------+

A typical schedule definition would look like::

	[section name]
	interval = 121
	days = ["saturday", "sunday"]
	period = [["02:00", "04:00"], ["19:00", "21:00"]]


A reference ``node.conf`` file can be found on the node at ``/opt/opensvc/usr/share/doc/node.conf``.

The syncservices action schedule is defined by the individual sync resource definitions in service configuration files, where ``sync_interval``, ``sync_days`` and ``sync_period`` parameters are available.

All actions except data syncs can be statistically delayed. The probability of running increases linearly from 25% to 100% during the first half of the action allowed period. This delay helps level to collector load.

.. warning::

	The ``/opt/opensvc/etc/.node.conf`` must not be edited by hand. It contains a cache of the computed schedules of all individual services' sync resources. As a cache, it is maintained by OpenSVC, and manual changes to this file would be overwritten.

Configuration for collector usage
=================================

By default, the collector is contacted by the node using the generic name ``dbopensvc`` on ports ``80`` and ``8000``. This name should be known to your prefered resolving mecanism : hosts, dns, ... If you choose to use the internet shared collector, the corresponding ip address must be set to the address of ``collector.opensvc.com``.

To override the default collector's xmlrpc urls, you can set them in node.conf::

	/opt/opensvc/bin/nodemgr set --param node.dbopensvc --value https://collector.opensvc.com/feed/default/call/xmlrpc
	/opt/opensvc/bin/nodemgr set --param node.dbcompliance --value https://collector.opensvc.com/init/compliance/call/xmlrpc


This override is recommended for xmlrpc encryption.

The collector requires the nodes to provide an authentication token (shared secret) with each request. The token is forged by the collector and stored on the node in ``node.conf``. The token initialization is handled by the command::

	/opt/opensvc/bin/nodemgr register


Finally, you can accelerate the node discovery by forcing the execution of opensvc cron jobs after the package installation::

	/opt/opensvc/bin/nodemgr --force pushasset
	/opt/opensvc/bin/nodemgr --force pushpkg
	/opt/opensvc/bin/nodemgr --force pushpatch
	/opt/opensvc/bin/nodemgr --force pushstats
	/opt/opensvc/bin/nodemgr --force pushservices
	/opt/opensvc/bin/nodemgr --force checks


To disable collector communications, use::

	/opt/opensvc/bin/nodemgr set --param node.dbopensvc --value None
	/opt/opensvc/bin/nodemgr set --param node.dbcompliance --value None


HP-UX specificities
===================

The python package provided by HP will output garbage on exec because it won't find terminfo at the expected places. To fix that, you have to export ``TERMINFO=/usr/share/lib/terminfo`` from ``/etc/profile``

The HP-UX base system does not provide tools to handle scsi persistent reservations. You have to install the scu tool if you want to activate this feature.

Linux LVM2 specificities
========================

OpenSVC controls volume group activation and desactivation. Most Linux distributions activate all visible volume groups at boot, some even re-activate them upon de-activation events. These mecanisms can be disabled using the following setup. It also provides another protection against unwanted volume group activation from a secondary cluster node.

This setup tells LVM2 commands to activate only the objects tagged with the hostname. Opensvc makes sure the tags are set on start and unset on stop. Opensvc also purges all tags before adding the one it needs to activate a volume group, so opensvc can satisfy a start request on a service uncleanly shut down.

/etc/lvm/lvm.conf
-----------------

Add the following root-level configuration node::

	tags {
	    hosttags = 1
	    local {}
	}

And add the ``local`` tag to all local volume groups. For example::

	vgchange --addtag local rootvg

Finally you need to rebuild the initrd/initramfs to prevent shared vg activation at boot.

/etc/lvm/lvm_{node}.conf
------------------------

Create this file, {node} being the output of uname -n and add the following configuration::

	activation { volume_list = ["@local", "@{node}"] }
